<div class="container py-4">

  <!-- V√©rification des permissions -->
  <div *ngIf="!auth.isAdmin() && !auth.hasRole('Manager')" class="alert alert-danger">
    ‚ö†Ô∏è Vous n'avez pas la permission de cr√©er des r√©unions.
    Seuls les administrateurs et chefs de projet peuvent cr√©er des r√©unions.
  </div>

  <!-- Formulaire (visible seulement pour Admin/Manager) -->
  <div *ngIf="auth.isAdmin() || auth.hasRole('Manager')">

    <h2 class="mb-4">üìÖ Cr√©er une nouvelle r√©union</h2>

    <form [formGroup]="form" (ngSubmit)="submit()">

      <!-- Projet -->
      <div class="mb-3">
        <label class="form-label fw-bold">Projet *</label>
        <select
          class="form-control"
          formControlName="projectId"
          (change)="onProjectChange()"
          [class.is-invalid]="form.get('projectId')?.invalid && form.get('projectId')?.touched">
          <option value="">-- S√©lectionner un projet --</option>
          <option *ngFor="let p of projects" [value]="p.id">
            {{ p.title }} (Propri√©taire: {{ p.owner?.username || 'N/A' }})
          </option>
        </select>
        <div class="invalid-feedback" *ngIf="form.get('projectId')?.invalid && form.get('projectId')?.touched">
          Veuillez s√©lectionner un projet.
        </div>
      </div>

      <!-- Date -->
      <div class="mb-3">
        <label class="form-label fw-bold">Date de la r√©union *</label>
        <input
          type="date"
          class="form-control"
          formControlName="meetingDate"
          [class.is-invalid]="form.get('meetingDate')?.invalid && form.get('meetingDate')?.touched">
        <div class="invalid-feedback" *ngIf="form.get('meetingDate')?.invalid && form.get('meetingDate')?.touched">
          Veuillez s√©lectionner une date.
        </div>
      </div>
       <!-- NOUVEAU : Heure de d√©but -->
  <div class="mb-3">
    <label class="form-label fw-bold">Heure de d√©but *</label>
    <input
      type="time"
      class="form-control"
      formControlName="startTime"
      [class.is-invalid]="form.get('startTime')?.invalid && form.get('startTime')?.touched"
      step="300"> <!-- Pas de 5 minutes -->
    <div class="invalid-feedback" *ngIf="form.get('startTime')?.invalid && form.get('startTime')?.touched">
      Veuillez s√©lectionner une heure de d√©but.
    </div>
  </div>

  <!-- NOUVEAU : Heure de fin -->
  <div class="mb-3">
    <label class="form-label fw-bold">Heure de fin *</label>
    <input
      type="time"
      class="form-control"
      formControlName="endTime"
      [class.is-invalid]="form.get('endTime')?.invalid && form.get('endTime')?.touched"
      step="300"
      (change)="calculateDuration()"> <!-- Appelle une fonction pour calculer la dur√©e -->
    <div class="invalid-feedback" *ngIf="form.get('endTime')?.invalid && form.get('endTime')?.touched">
      Veuillez s√©lectionner une heure de fin.
    </div>
  </div>

  <!-- NOUVEAU : Dur√©e (calcul√©e automatiquement) -->
  <div class="mb-3">
    <label class="form-label fw-bold">Dur√©e</label>
    <div class="input-group">
      <input
        type="number"
        class="form-control"
        formControlName="durationMinutes"
        min="15"
        max="480"
        readonly> <!-- Lecture seule car calcul√©e automatiquement -->
      <span class="input-group-text">minutes</span>
    </div>
    <small class="text-muted">Calcul√©e automatiquement √† partir des heures de d√©but et fin.</small>
    <div *ngIf="form.get('durationMinutes')?.value > 0" class="mt-1">
      <span class="badge bg-info">{{ formatDuration(form.get('durationMinutes')?.value) }}</span>
    </div>
  </div>

      <!-- Participants -->
      <div class="mb-4">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <label class="form-label fw-bold">Participants *</label>
          <button type="button" class="btn btn-sm btn-outline-primary" (click)="addAttendee()">
            <i class="bi bi-plus-circle"></i> Ajouter
          </button>
        </div>

        <div formArrayName="attendees">
          <div *ngFor="let a of attendees.controls; let i = index" class="d-flex align-items-center mb-2">

            <select
              class="form-control me-2"
              [formControlName]="i"
              [class.is-invalid]="a.invalid && a.touched">
              <option value="">-- Choisir un participant --</option>
              <option *ngFor="let u of users" [value]="u.id">
                {{ u.username }} ({{ u.role }})
              </option>
            </select>

            <button
              type="button"
              class="btn btn-sm btn-outline-danger"
              (click)="removeAttendee(i)"
              [disabled]="attendees.length <= 1">
              <i class="bi bi-trash"></i>
            </button>

          </div>
        </div>

        <small class="text-muted">Au moins un participant est requis.</small>
      </div>

      <!-- D√©cisions/T√¢ches -->
      <div class="mb-4">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <label class="form-label fw-bold">D√©cisions (T√¢ches discut√©es)</label>
          <button
            type="button"
            class="btn btn-sm btn-outline-primary"
            (click)="addDecision()"
            [disabled]="!form.value.projectId">
            <i class="bi bi-plus-circle"></i> Ajouter
          </button>
        </div>

        <div *ngIf="!form.value.projectId" class="alert alert-warning">
          ‚ö†Ô∏è Veuillez d'abord s√©lectionner un projet pour voir ses t√¢ches.
        </div>

        <div formArrayName="decisions">
          <div *ngFor="let d of decisions.controls; let i = index" class="d-flex align-items-center mb-2">

            <select
              class="form-control me-2"
              [formControlName]="i"
              [class.is-invalid]="d.invalid && d.touched">
              <option value="">-- Choisir une t√¢che --</option>
              <option *ngFor="let t of tasks" [value]="t.id">
                {{ t.title }} (√âch√©ance: {{ t.dueDate | date:'shortDate' }})
              </option>
            </select>

            <button
              type="button"
              class="btn btn-sm btn-outline-danger"
              (click)="removeDecision(i)">
              <i class="bi bi-trash"></i>
            </button>

          </div>
        </div>

        <small class="text-muted">
          S√©lectionnez les t√¢ches qui seront discut√©es lors de cette r√©union.
          {{ tasks.length }} t√¢che(s) disponible(s) pour ce projet.
        </small>
      </div>

      <!-- Messages d'erreur et succ√®s -->
      <div *ngIf="error" class="alert alert-danger">
        <i class="bi bi-exclamation-triangle"></i> {{ error }}
      </div>

      <div *ngIf="success" class="alert alert-success">
        <i class="bi bi-check-circle"></i> {{ success }}
      </div>

      <!-- Boutons -->
      <div class="d-flex gap-2">
        <button
          class="btn btn-primary"
          type="submit"
          [disabled]="form.invalid || isSubmitting">

          <span *ngIf="!isSubmitting">
            <i class="bi bi-calendar-plus"></i> Cr√©er la r√©union
          </span>
          <span *ngIf="isSubmitting">
            <span class="spinner-border spinner-border-sm me-2"></span>
            Cr√©ation en cours...
          </span>
        </button>

        <button
          type="button"
          class="btn btn-outline-secondary"
          (click)="router.navigate(['/meetings'])">
          <i class="bi bi-arrow-left"></i> Retour aux r√©unions
        </button>
      </div>

    </form>
  </div>

</div>
