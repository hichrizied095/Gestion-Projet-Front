<div class="chat-container">
  <!-- Liste des conversations -->
  <div class="user-list">
    <div class="p-2 border-bottom d-flex justify-content-between align-items-center">
      <h5 class="mb-0">ðŸ’¬ Messages</h5>
    </div>
    <ul class="list-unstyled">
      <li *ngFor="let conversation of conversations" (click)="selectUser(conversation)"
        [class.active]="conversation === selectedUser" [class.unread]="conversation.unreadCount > 0"
        class="p-2 user-item">
        <div class="d-flex justify-content-between align-items-start">
          <div class="flex-grow-1">
            <!-- âœ… Nom de l'utilisateur en gras si messages non lus -->
            <div class="user-name" [class.fw-bold]="conversation.unreadCount > 0">
              {{ conversation.username }}
            </div>
            <!-- âœ… AperÃ§u du dernier message -->
            <div class="last-message text-muted small">
              {{ truncateMessage(conversation.lastMessage) }}
            </div>
          </div>
          <div class="d-flex flex-column align-items-end">
            <!-- âœ… Heure du dernier message -->
            <small class="text-muted timestamp">
              {{ conversation.lastMessageTime | date: 'shortTime' }}
            </small>
            <!-- âœ… Badge de messages non lus pour cette conversation -->
            <span *ngIf="conversation.unreadCount > 0" class="badge bg-primary rounded-pill mt-1">
              {{ conversation.unreadCount }}
            </span>
          </div>
        </div>
      </li>
    </ul>
  </div>

  <!-- FenÃªtre de discussion -->
  <div class="chat-window">
    <ng-container *ngIf="selectedUser; else noUser">
      <!-- En-tÃªte -->
      <div class="chat-header border-bottom p-2">
        <h6>ðŸ’¬ Discussion avec {{ selectedUser.username }}</h6>
      </div>

      <!-- Messages avec rÃ©fÃ©rence pour auto-scroll -->
      <div class="chat-messages" #messagesContainer>
        <div *ngFor="let msg of messages" class="message-item"
          [ngClass]="{ 'me': msg.senderId === currentUserId, 'other': msg.senderId !== currentUserId }">
          <div class="message-meta">
            <strong>{{ msg.senderId === currentUserId ? 'Moi' : msg.senderName || selectedUser.username }}</strong>
            <span class="timestamp">{{ msg.sentAt | date: 'shortTime' }}</span>
            <!-- âœ… Indicateur de lecture pour mes messages -->
            <span *ngIf="msg.senderId === currentUserId" class="message-status" [class.read]="msg.isRead">
              <span *ngIf="msg.isRead" title="Lu">âœ“âœ“</span>
              <span *ngIf="!msg.isRead" title="EnvoyÃ©">âœ“</span>
            </span>
          </div>
          <div class="message-bubble">
            {{ msg.content }}
          </div>
        </div>
      </div>

      <!-- Saisie -->
      <div class="chat-input border-top p-2 d-flex">
        <input [(ngModel)]="newMessage" type="text" class="form-control" placeholder="Ã‰crire un message..."
          (keyup.enter)="sendMessage()" />
        <button class="btn btn-primary ms-2" (click)="sendMessage()">Envoyer</button>
      </div>
    </ng-container>

    <!-- Aucun utilisateur sÃ©lectionnÃ© -->
    <ng-template #noUser>
      <div class="p-3 text-muted text-center">
        ðŸ’­ SÃ©lectionnez une conversation pour commencer.
      </div>
    </ng-template>
  </div>
</div>