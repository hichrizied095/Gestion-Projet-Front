<div class="profile-container">
  <div class="container py-5">
    
    <!-- Messages -->
    <div *ngIf="successMessage" class="alert alert-success alert-dismissible fade show">
      <i class="fas fa-check-circle me-2"></i>{{ successMessage }}
      <button type="button" class="btn-close" (click)="successMessage = ''"></button>
    </div>

    <div *ngIf="errorMessage" class="alert alert-danger alert-dismissible fade show">
      <i class="fas fa-exclamation-circle me-2"></i>{{ errorMessage }}
      <button type="button" class="btn-close" (click)="errorMessage = ''"></button>
    </div>

    <!-- Loading -->
    <div *ngIf="loading && !userProfile" class="text-center py-5">
      <div class="spinner-border text-primary"></div>
    </div>

    <!-- Profil -->
    <div *ngIf="userProfile" class="row g-4">
      
      <!-- Colonne gauche - Carte profil -->
      <div class="col-lg-4">
        <div class="profile-card">
          <div class="profile-avatar">
            <div class="avatar-circle-large">{{ getInitials() }}</div>
          </div>

          <div class="profile-info text-center">
            <h3 class="profile-name">{{ userProfile.username }}</h3>
            <div class="profile-role">
              <span class="badge" [ngClass]="getRoleBadgeClass()">
                <i class="fas" [ngClass]="getRoleIcon()"></i>
                {{ userProfile.role }}
              </span>
            </div>

            <div class="profile-status mt-3">
              <span *ngIf="userProfile.isApproved" class="badge bg-success">
                <i class="fas fa-check-circle me-1"></i>Compte approuvé
              </span>
              <span *ngIf="!userProfile.isApproved" class="badge bg-warning text-dark">
                <i class="fas fa-clock me-1"></i>En attente
              </span>
            </div>
          </div>

          <div class="profile-stats">
            <div class="stat-item">
              <i class="fas fa-shield-alt"></i>
              <div>
                <span class="stat-label">Rôle</span>
                <span class="stat-value">{{ userProfile.role }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Colonne droite - Formulaires -->
      <div class="col-lg-8">
        
        <!-- Carte: Informations -->
        <div class="settings-card mb-4">
          <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="mb-0">
                <i class="fas fa-user-cog me-2"></i>Informations du profil
              </h5>
              <button *ngIf="!isEditingProfile" class="btn btn-primary btn-sm" (click)="toggleEditProfile()">
                <i class="fas fa-edit me-1"></i>Modifier
              </button>
            </div>
          </div>

          <div class="card-body">
            <form [formGroup]="profileForm" (ngSubmit)="updateProfile()">
              
              <div class="form-group mb-4">
                <label class="form-label">
                  <i class="fas fa-user me-2"></i>Nom d'utilisateur
                </label>
                <input type="text" class="form-control" formControlName="username" [readonly]="!isEditingProfile"
                  [class.is-invalid]="profileForm.get('username')?.invalid && profileForm.get('username')?.touched">
                <div class="invalid-feedback" *ngIf="profileForm.get('username')?.errors?.['required']">
                  Le nom d'utilisateur est requis
                </div>
                <div class="invalid-feedback" *ngIf="profileForm.get('username')?.errors?.['minlength']">
                  Minimum 3 caractères
                </div>
              </div>

              <div class="form-group mb-4">
                <label class="form-label">
                  <i class="fas fa-shield-alt me-2"></i>Rôle
                </label>
                <input type="text" class="form-control" [value]="userProfile.role" readonly>
                <small class="text-muted">
                  <i class="fas fa-info-circle me-1"></i>Seul un administrateur peut modifier votre rôle
                </small>
              </div>

              <div *ngIf="isEditingProfile" class="form-actions">
                <button type="submit" class="btn btn-success" [disabled]="profileForm.invalid || loading">
                  <i class="fas fa-save me-1"></i>
                  <span *ngIf="!loading">Enregistrer</span>
                  <span *ngIf="loading">
                    <span class="spinner-border spinner-border-sm me-1"></span>Enregistrement...
                  </span>
                </button>
                <button type="button" class="btn btn-secondary" (click)="toggleEditProfile()" [disabled]="loading">
                  <i class="fas fa-times me-1"></i>Annuler
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- Carte: Mot de passe -->
        <div class="settings-card">
          <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="mb-0">
                <i class="fas fa-lock me-2"></i>Sécurité du compte
              </h5>
              <button *ngIf="!isChangingPassword" class="btn btn-warning btn-sm" (click)="toggleChangePassword()">
                <i class="fas fa-key me-1"></i>Changer le mot de passe
              </button>
            </div>
          </div>

          <div class="card-body">
            <div *ngIf="!isChangingPassword" class="password-info">
              <i class="fas fa-shield-alt text-success fa-3x mb-3"></i>
              <p class="text-muted mb-0">Votre mot de passe est sécurisé.</p>
            </div>

            <form *ngIf="isChangingPassword" [formGroup]="passwordForm" (ngSubmit)="changePassword()">
              
              <div class="form-group mb-3">
                <label class="form-label">
                  <i class="fas fa-lock me-2"></i>Mot de passe actuel
                </label>
                <input type="password" class="form-control" formControlName="currentPassword"
                  placeholder="Entrez votre mot de passe actuel"
                  [class.is-invalid]="passwordForm.get('currentPassword')?.invalid && passwordForm.get('currentPassword')?.touched">
                <div class="invalid-feedback">Le mot de passe actuel est requis</div>
              </div>

              <div class="form-group mb-3">
                <label class="form-label">
                  <i class="fas fa-key me-2"></i>Nouveau mot de passe
                </label>
                <input type="password" class="form-control" formControlName="newPassword"
                  placeholder="Entrez un nouveau mot de passe"
                  [class.is-invalid]="passwordForm.get('newPassword')?.invalid && passwordForm.get('newPassword')?.touched">
                <div class="invalid-feedback" *ngIf="passwordForm.get('newPassword')?.errors?.['required']">
                  Le nouveau mot de passe est requis
                </div>
                <div class="invalid-feedback" *ngIf="passwordForm.get('newPassword')?.errors?.['minlength']">
                  Minimum 6 caractères
                </div>
                <small class="text-muted">
                  <i class="fas fa-info-circle me-1"></i>Au moins 6 caractères
                </small>
              </div>

              <div class="form-group mb-4">
                <label class="form-label">
                  <i class="fas fa-check-double me-2"></i>Confirmer le mot de passe
                </label>
                <input type="password" class="form-control" formControlName="confirmPassword"
                  placeholder="Confirmez votre nouveau mot de passe"
                  [class.is-invalid]="(passwordForm.get('confirmPassword')?.invalid && passwordForm.get('confirmPassword')?.touched) || passwordForm.errors?.['passwordMismatch']">
                <div class="invalid-feedback" *ngIf="passwordForm.get('confirmPassword')?.errors?.['required']">
                  La confirmation est requise
                </div>
                <div class="invalid-feedback" *ngIf="passwordForm.errors?.['passwordMismatch'] && passwordForm.get('confirmPassword')?.touched">
                  Les mots de passe ne correspondent pas
                </div>
              </div>

              <div class="form-actions">
                <button type="submit" class="btn btn-warning" [disabled]="passwordForm.invalid || loading">
                  <i class="fas fa-key me-1"></i>
                  <span *ngIf="!loading">Changer le mot de passe</span>
                  <span *ngIf="loading">
                    <span class="spinner-border spinner-border-sm me-1"></span>Changement...
                  </span>
                </button>
                <button type="button" class="btn btn-secondary" (click)="toggleChangePassword()" [disabled]="loading">
                  <i class="fas fa-times me-1"></i>Annuler
                </button>
              </div>
            </form>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>