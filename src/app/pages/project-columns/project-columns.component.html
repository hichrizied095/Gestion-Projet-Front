<h2>Colonnes du projet</h2>

<div class="columns-container">
  <div *ngFor="let column of columnsWithTasks" class="column-card">

    <!-- ============================================
         EN-TÃŠTE DE COLONNE AVEC INFO DE POIDS
         ============================================ -->
    <div class="column-header">
      <h3>{{ column.name }}</h3>

      <!-- Progression avec systÃ¨me de poids -->
      <div class="progress-container" *ngIf="column.tasks.length > 0">
        <div class="progress-bar">
          <div class="progress-fill" [class.progress-success]="getCompletionPercentage(column.tasks) === 100"
            [class.progress-warning]="getCompletionPercentage(column.tasks) > 0 && getCompletionPercentage(column.tasks) < 100"
            [class.progress-danger]="getCompletionPercentage(column.tasks) === 0"
            [style.width.%]="getCompletionPercentage(column.tasks)"></div>
        </div>
        <small class="completion-text">
          {{ getCompletionPercentage(column.tasks) }}% complÃ©tÃ©
        </small>

        <!-- âœ… NOUVEAU: Indicateur de poids total -->
        <div class="weight-indicator mt-2">
          <small [class.text-danger]="isOverweighted(column.tasks)"
            [class.text-success]="getTotalWeight(column.tasks) === 100"
            [class.text-warning]="getTotalWeight(column.tasks) > 0 && getTotalWeight(column.tasks) < 100"
            [class.text-muted]="getTotalWeight(column.tasks) === 0">

            <i class="fas fa-weight-hanging me-1"></i>

            <strong>Poids total : {{ getTotalWeight(column.tasks) }}%</strong>

            <!-- Alerte surcharge -->
            <span *ngIf="isOverweighted(column.tasks)" class="ms-1">
              âš ï¸ <strong>Surcharge!</strong>
            </span>

            <!-- Poids restant -->
            <span *ngIf="getTotalWeight(column.tasks) < 100" class="ms-1">
              ({{ getRemainingWeight(column.tasks) }}% disponible)
            </span>

            <!-- Colonne complÃ¨te -->
            <span *ngIf="getTotalWeight(column.tasks) === 100 && !isOverweighted(column.tasks)" class="ms-1">
              âœ… <strong>Complet</strong>
            </span>
          </small>
        </div>

        <!-- ğŸ“˜ Bouton Gantt -->
        <button class="btn btn-outline-primary btn-sm mt-2 w-100" (click)="openGanttModal(column.tasks)">
          ğŸ“Š Voir le diagramme de Gantt
        </button>
      </div>

      <!-- Message si colonne vide -->
      <div *ngIf="column.tasks.length === 0" class="empty-column-message">
        <small class="text-muted">
          <i class="fas fa-info-circle me-1"></i>
          Aucune tÃ¢che dans cette colonne
        </small>
      </div>
    </div>

    <!-- ============================================
         LISTE DES TÃ‚CHES AVEC DND
         ============================================ -->
    <ul cdkDropList [cdkDropListData]="column.tasks" [cdkDropListConnectedTo]="connectedDropListsIds"
      [id]="'list-' + column.id" class="task-list" (cdkDropListDropped)="onDrop($event, column.id)">

      <li *ngFor="let task of column.tasks" cdkDrag class="task-item" (click)="openTaskDetails(task)">

        <!-- Bouton supprimer -->
        <button (click)="deleteTask(task.id); $event.stopPropagation()" class="btn btn-sm btn-danger float-end"
          title="Supprimer la tÃ¢che">
          âœ•
        </button>

        <!-- Titre et checkbox -->
        <label (click)="$event.stopPropagation()">
          <input type="checkbox" [checked]="task.isCompleted" (change)="toggleTaskCompletion(task)" />
          <span [class.completed]="task.isCompleted">{{ task.title }}</span>

          <!-- Badge de poids de la tÃ¢che (NOUVEAU) -->
          <span class="badge bg-info ms-2" *ngIf="task.percentage && task.percentage > 0">
            {{ task.percentage }}%
          </span>

          <small *ngIf="task.assignedUserName" class="text-muted d-block">
            ğŸ‘¤ AssignÃ©e Ã  : {{ task.assignedUserName }}
          </small>
        </label>

        <!-- Section fichier -->
        <div class="file-section" (click)="$event.stopPropagation()">
          <!-- Bouton upload -->
          <div *ngIf="!task.filePath">
            <input type="file" #fileInput style="display: none" (change)="uploadFile($event, task.id)" />
            <button class="btn btn-sm btn-outline-secondary" (click)="fileInput.click(); $event.stopPropagation()">
              ğŸ“ Joindre un fichier
            </button>
          </div>

          <!-- Fichier existant -->
          <div *ngIf="task.filePath" class="file-preview">
            <a [href]="getFileUrl(task.id)" target="_blank" class="btn btn-sm btn-link" [title]="getFileName(task)">
              ğŸ“„ {{ getFileName(task) }}
            </a>
            <button class="btn btn-sm btn-outline-danger ms-2" (click)="deleteFile(task.id); $event.stopPropagation()">
              âœ•
            </button>
          </div>
        </div>

        <!-- Statut avec indicateur de retard -->
        <div class="status-container">
          <span class="status-badge" [ngClass]="{
              'badge-planifiee': getTaskStatus(task) === 'PlanifiÃ©e',
              'badge-en-cours': getTaskStatus(task) === 'En cours',
              'badge-terminee': getTaskStatus(task) === 'TerminÃ©e',
              'badge-en-retard': getTaskStatus(task) === 'En retard'
            }">
            {{ getTaskStatus(task) }}
          </span>

          <!-- âœ… NOUVEAU: Indicateur de retard pour tÃ¢ches en cours -->
          <span *ngIf="isLate(task) && getTaskStatus(task) === 'En cours'" class="badge bg-warning text-dark ms-1"
            title="Cette tÃ¢che est en retard">
            âš ï¸ En retard
          </span>
        </div>

        <span *ngIf="task.updated" class="saved-feedback">âœ“</span>
      </li>
    </ul>

    <!-- ============================================
         AJOUTER UNE TÃ‚CHE
         ============================================ -->
    <div class="add-task-form">
      <button class="btn btn-primary w-100" (click)="openAddTaskModal(column.id)">
        â• Ajouter une tÃ¢che
      </button>
    </div>

    <!-- ============================================
         SUPPRIMER COLONNE
         ============================================ -->
    <button class="delete-btn" (click)="deleteColumn(column.id)">
      ğŸ—‘ï¸ Supprimer la colonne
    </button>
  </div>
</div>

<!-- ============================================
     AJOUTER COLONNE
     ============================================ -->
<div class="add-column-form mt-3">
  <input [(ngModel)]="newColumnName" placeholder="Nouvelle colonne" />
  <button (click)="addColumn()">â• Ajouter</button>
</div>

<!-- ============================================
     MODALE GANTT
     ============================================ -->
<div class="modal fade" id="ganttModal" tabindex="-1" aria-labelledby="ganttModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="ganttModalLabel">Diagramme de Gantt</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer">
        </button>
      </div>
      <div class="modal-body">
        <app-gantt-modal [tasks]="selectedTasks"></app-gantt-modal>
      </div>
    </div>
  </div>
</div>