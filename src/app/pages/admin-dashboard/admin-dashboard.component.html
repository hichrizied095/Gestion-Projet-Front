<div class="dashboard-wrapper">

  <!-- ========================================
       BACKGROUND DECORATIONS
       ======================================== -->
  <div class="background-decoration">
    <div class="blob blob-1"></div>
    <div class="blob blob-2"></div>
    <div class="blob blob-3"></div>
  </div>

  <div class="dashboard-content">

    <!-- ========================================
         HEADER MODERN
         ======================================== -->
    <header class="dashboard-header-modern">
      <div class="header-glass">
        <div class="header-left">
          <div class="header-icon-wrapper">
            <i class="bi bi-speedometer2"></i>
          </div>
          <div class="header-text">
            <h1>Dashboard Admin</h1>
            <p>
              <i class="bi bi-clock-fill"></i>
              {{ lastUpdated | date:'dd MMMM yyyy, HH:mm' }}
            </p>
          </div>
        </div>
        <div class="header-right">
          <button class="btn-modern btn-refresh" (click)="refreshDashboard()" [disabled]="isLoading">
            <i class="bi bi-arrow-clockwise" [class.spinning]="isLoading"></i>
            {{ isLoading ? 'Chargement' : 'Actualiser' }}
          </button>
          <button class="btn-modern btn-export" (click)="exportReport()">
            <i class="bi bi-download"></i>
            Exporter
          </button>
        </div>
      </div>
    </header>

    <!-- ========================================
         STATS CARDS MODERN
         ======================================== -->
    <section class="stats-section-modern">
      <div class="stats-grid-modern">

        <!-- Card 1: Users -->
        <div class="stat-card-modern stat-gradient-blue">
          <div class="stat-card-glass">
            <div class="stat-header-modern">
              <div class="stat-icon-modern">
                <i class="bi bi-people-fill"></i>
              </div>
              <div class="stat-trend" *ngIf="stats.pendingUsers > 0">
                <span class="trend-badge trend-warning">
                  <i class="bi bi-exclamation-circle"></i>
                  {{ stats.pendingUsers }}
                </span>
              </div>
            </div>
            <div class="stat-body-modern">
              <div class="stat-number">{{ stats.totalUsers }}</div>
              <div class="stat-label">Utilisateurs</div>
              <div class="stat-details-modern">
                <span class="detail-chip">
                  <i class="bi bi-check-circle-fill"></i>
                  {{ stats.approvedUsers }} approuvés
                </span>
                <span class="detail-chip">
                  <i class="bi bi-shield-fill-check"></i>
                  {{ roleStats.Admin }} admins
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- Card 2: Projects -->
        <div class="stat-card-modern stat-gradient-purple">
          <div class="stat-card-glass">
            <div class="stat-header-modern">
              <div class="stat-icon-modern">
                <i class="bi bi-kanban-fill"></i>
              </div>
              <div class="stat-trend">
                <span class="trend-badge trend-success">
                  <i class="bi bi-arrow-up"></i>
                  {{ stats.activeProjects }}
                </span>
              </div>
            </div>
            <div class="stat-body-modern">
              <div class="stat-number">{{ stats.totalProjects }}</div>
              <div class="stat-label">Projets actifs</div>
              <div class="stat-details-modern">
                <span class="detail-chip">
                  <i class="bi bi-graph-up"></i>
                  {{ stats.overallProgress }}% progression
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- Card 3: Tasks -->
        <div class="stat-card-modern stat-gradient-green">
          <div class="stat-card-glass">
            <div class="stat-header-modern">
              <div class="stat-icon-modern">
                <i class="bi bi-check2-square"></i>
              </div>
              <div class="stat-trend">
                <span class="trend-badge trend-info">
                  {{ stats.completionRate }}%
                </span>
              </div>
            </div>
            <div class="stat-body-modern">
              <div class="stat-number">{{ stats.totalTasks }}</div>
              <div class="stat-label">Tâches</div>
              <div class="stat-details-modern">
                <span class="detail-chip chip-success">
                  {{ stats.completedTasks }} terminées
                </span>
                <span class="detail-chip chip-danger" *ngIf="stats.overdueTasks > 0">
                  {{ stats.overdueTasks }} en retard
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- Card 4: Meetings -->
        <div class="stat-card-modern stat-gradient-orange">
          <div class="stat-card-glass">
            <div class="stat-header-modern">
              <div class="stat-icon-modern">
                <i class="bi bi-calendar-event-fill"></i>
              </div>
              <div class="stat-trend">
                <span class="trend-badge trend-warning">
                  <i class="bi bi-clock-fill"></i>
                  {{ stats.todayMeetings }}
                </span>
              </div>
            </div>
            <div class="stat-body-modern">
              <div class="stat-number">{{ stats.upcomingMeetings }}</div>
              <div class="stat-label">Réunions</div>
              <div class="stat-details-modern">
                <span class="detail-chip">
                  <i class="bi bi-list-check"></i>
                  {{ stats.todayTasks }} tâches aujourd'hui
                </span>
              </div>
            </div>
          </div>
        </div>

      </div>
    </section>

    <!-- ========================================
         QUICK ACTIONS & ALERTS
         ======================================== -->
    <div class="content-grid-modern">

      <!-- Pending Users Alert -->
      <div class="alert-card-modern" *ngIf="pendingUsers.length > 0">
        <div class="alert-glass">
          <div class="alert-header-modern">
            <div class="alert-icon-wrapper">
              <i class="bi bi-bell-fill"></i>
            </div>
            <div class="alert-title">
              <h3>Utilisateurs en attente</h3>
              <span class="alert-count">{{ pendingUsers.length }} action(s) requise(s)</span>
            </div>
          </div>

          <div class="pending-list-modern">
            <div class="pending-item-modern" *ngFor="let user of pendingUsers.slice(0, 3)">
              <div class="pending-avatar">
                <i class="bi bi-person-circle"></i>
              </div>
              <div class="pending-info">
                <h4>{{ user.username }}</h4>
                <p>
                  <span class="role-tag" [class]="'role-' + user.role.toLowerCase()">
                    {{ user.role }}
                  </span>
                </p>
              </div>
              <div class="pending-actions">
                <button class="btn-icon btn-success" (click)="approveUser(user.id); $event.stopPropagation()">
                  <i class="bi bi-check-lg"></i>
                </button>
                <button class="btn-icon btn-danger" (click)="rejectUser(user.id); $event.stopPropagation()">
                  <i class="bi bi-x-lg"></i>
                </button>
              </div>
            </div>
          </div>

          <div class="alert-footer" *ngIf="pendingUsers.length > 3">
            <button class="btn-link-modern" (click)="navigateTo('/admin/users')">
              Voir tous les {{ pendingUsers.length }} utilisateurs
              <i class="bi bi-arrow-right"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="actions-card-modern">
        <div class="actions-glass">
          <div class="actions-header">
            <h3>
              <i class="bi bi-lightning-charge-fill"></i>
              Actions rapides
            </h3>
          </div>
          <div class="actions-grid">
            <div class="action-item-modern" *ngFor="let action of quickActions"
                 (click)="navigateTo(action.route)">
              <div class="action-icon-modern" [style.background]="'linear-gradient(135deg, ' + action.color + '40, ' + action.color + '10)'">
                <i class="bi" [ngClass]="action.icon" [style.color]="action.color"></i>
              </div>
              <div class="action-text">
                <h4>{{ action.title }}</h4>
                <p>{{ action.description }}</p>
              </div>
              <div class="action-badge" *ngIf="action.count">
                <span [style.background]="action.color">{{ action.count }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- ========================================
         CHARTS SECTION
         ======================================== -->
    <section class="charts-section-modern">
      <div class="section-header-modern">
        <h2>
          <i class="bi bi-bar-chart-fill"></i>
          Analytiques
        </h2>
      </div>

      <div class="charts-grid-modern">

        <!-- Chart 1: Role Distribution -->
        <div class="chart-card-modern chart-small">
          <div class="chart-glass">
            <div class="chart-header-modern">
              <h3>Répartition des rôles</h3>
              <span class="chart-badge">{{ stats.totalUsers }} users</span>
            </div>
            <div class="chart-container-modern">
              <canvas #roleChartCanvas baseChart
                [data]="roleChartData"
                [options]="roleChartOptions"
                [type]="'doughnut'">
              </canvas>
            </div>
            <div class="chart-legend-modern">
              <div class="legend-item-modern">
                <span class="legend-dot dot-red"></span>
                <span>Admin</span>
                <strong>{{ roleStats.Admin }}</strong>
              </div>
              <div class="legend-item-modern">
                <span class="legend-dot dot-orange"></span>
                <span>Manager</span>
                <strong>{{ roleStats.Manager }}</strong>
              </div>
              <div class="legend-item-modern">
                <span class="legend-dot dot-green"></span>
                <span>Membre</span>
                <strong>{{ roleStats.Member }}</strong>
              </div>
            </div>
          </div>
        </div>

        <!-- Chart 2: Task Status -->
        <div class="chart-card-modern chart-large">
          <div class="chart-glass">
            <div class="chart-header-modern">
              <h3>Statut des tâches</h3>
              <span class="chart-badge">{{ stats.totalTasks }} tâches</span>
            </div>
            <div class="chart-container-modern">
              <canvas #taskStatusChartCanvas baseChart
                [data]="taskStatusChartData"
                [options]="taskStatusChartOptions"
                [type]="'bar'">
              </canvas>
            </div>
          </div>
        </div>

        <!-- Chart 3: Monthly Activity -->
        <div class="chart-card-modern chart-large">
          <div class="chart-glass">
            <div class="chart-header-modern">
              <h3>Tendances mensuelles</h3>
              <span class="chart-badge">6 mois</span>
            </div>
            <div class="chart-container-modern">
              <canvas #monthlyTasksChartCanvas baseChart
                [data]="monthlyTasksChartData"
                [options]="monthlyTasksChartOptions"
                [type]="'line'">
              </canvas>
            </div>
          </div>
        </div>

        <!-- Chart 4: Project Progress -->
        <div class="chart-card-modern chart-small">
          <div class="chart-glass">
            <div class="chart-header-modern">
              <h3>Top projets</h3>
              <span class="chart-badge">5 actifs</span>
            </div>
            <div class="projects-list-modern">
              <div class="project-item-modern" *ngFor="let project of projectStats">
                <div class="project-info-modern">
                  <h4>{{ project.name }}</h4>
                  <span>{{ project.completed }}/{{ project.tasks }} tâches</span>
                </div>
                <div class="project-progress-modern">
                  <div class="progress-ring">
                    <svg width="60" height="60">
                      <circle class="progress-ring-circle-bg" cx="30" cy="30" r="25"></circle>
                      <circle class="progress-ring-circle"
                              cx="30" cy="30" r="25"
                              [style.strokeDashoffset]="157 - (157 * project.progress / 100)"
                              [ngClass]="{
                                'progress-high': project.progress >= 80,
                                'progress-medium': project.progress >= 50 && project.progress < 80,
                                'progress-low': project.progress < 50
                              }">
                      </circle>
                      <text x="30" y="35" class="progress-text">{{ project.progress }}%</text>
                    </svg>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </section>

    <!-- ========================================
         ACTIVITY & TASKS
         ======================================== -->
    <section class="feed-section-modern">
      <div class="feed-grid-modern">

        <!-- Activity Feed -->
        <div class="feed-card-modern">
          <div class="feed-glass">
            <div class="feed-header-modern">
              <h3>
                <i class="bi bi-activity"></i>
                Fil d'activité
              </h3>
              <span class="time-chip">Dernières 24h</span>
            </div>
            <div class="activity-timeline-modern">
              <div class="timeline-item-modern" *ngFor="let activity of recentActivities">
                <div class="timeline-marker" [ngClass]="getActivityColor(activity.type)"></div>
                <div class="timeline-content">
                  <div class="timeline-header">
                    <h4>{{ activity.title }}</h4>
                    <span class="timeline-time">{{ formatDate(activity.date) }}</span>
                  </div>
                  <p>{{ activity.description }}</p>
                  <div class="timeline-footer">
                    <span class="timeline-user">
                      <i class="bi bi-person"></i>
                      {{ activity.userName }}
                    </span>
                    <span *ngIf="activity.status"
                          class="timeline-status"
                          [ngClass]="'status-' + getStatusColor(activity.status)">
                      {{ activity.status }}
                    </span>
                  </div>
                </div>
              </div>
              <div *ngIf="recentActivities.length === 0" class="empty-state-modern">
                <i class="bi bi-inbox"></i>
                <p>Aucune activité récente</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Recent Tasks -->
        <div class="tasks-card-modern">
          <div class="tasks-glass">
            <div class="tasks-header-modern">
              <h3>
                <i class="bi bi-list-check"></i>
                Tâches récentes
              </h3>
              <button class="btn-link-modern" (click)="navigateTo('/mes-taches')">
                Voir tout
                <i class="bi bi-arrow-right"></i>
              </button>
            </div>
            <div class="tasks-list-modern">
              <div class="task-item-modern" *ngFor="let task of recentTasks"
                   (click)="navigateTo('/tasks/' + task.id)">
                <div class="task-check">
                  <div class="checkbox-modern" [class.checked]="task.isCompleted">
                    <i class="bi" [ngClass]="task.isCompleted ? 'bi-check-lg' : ''"></i>
                  </div>
                </div>
                <div class="task-content-modern">
                  <h4 [class.completed]="task.isCompleted">{{ task.title }}</h4>
                  <div class="task-meta-modern">
                    <span *ngIf="task.assignedUserName" class="meta-chip">
                      <i class="bi bi-person"></i>
                      {{ task.assignedUserName }}
                    </span>
                    <span class="meta-chip meta-date"
                          [ngClass]="{
                            'meta-danger': getStatus(task) === 'En retard',
                            'meta-warning': getStatus(task) === 'En cours'
                          }">
                      <i class="bi bi-calendar"></i>
                      {{ task.dueDate | date:'dd/MM' }}
                    </span>
                  </div>
                </div>
                <div class="task-status-modern">
                  <span class="status-indicator"
                        [ngClass]="'indicator-' + getStatusColor(getStatus(task))">
                  </span>
                </div>
              </div>
              <div *ngIf="recentTasks.length === 0" class="empty-state-modern">
                <i class="bi bi-inbox"></i>
                <p>Aucune tâche récente</p>
              </div>
            </div>
          </div>
        </div>

      </div>
    </section>

  </div>

  <!-- Loading -->
  <div *ngIf="isLoading" class="loading-modern">
    <div class="loading-content">
      <div class="loading-spinner-modern"></div>
      <p>Chargement des données...</p>
    </div>
  </div>

</div>
